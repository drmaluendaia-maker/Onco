<script>
    // --- ALL JS FUNCTIONS ---
    document.addEventListener('DOMContentLoaded', () => {
        setupTheme();
        setupMobileMenu();
        setupFavorites();
        setupTabs();
        setupGlobalSearch();
        attachCalculatorFunctions(); // Esta función ahora es válida
        setupDrugCalculator();
    });

    // --- DRUG DATABASE & CALCULATOR ---
    const drugDb = {
        allopurinol: { name: 'Alopurinol', group: 'Antigotosos', dose: (w) => `Dosis diaria: <strong>${(10*w).toFixed(0)} mg</strong> (en 3 tomas).`, calculation: (w) => `Dosis (mg) = Peso (kg) × 10 mg/kg<br>= ${w} kg × 10 mg/kg = <strong>${(10*w).toFixed(0)} mg/día</strong>`},
        ceftriaxona: { name: 'Ceftriaxona', group: 'Cefalosporinas', dose: (w) => `Dosis diaria: <strong>${(100*w).toFixed(0)} mg</strong> (cada 24h).`, calculation: (w) => `Dosis (mg) = Peso (kg) × 100 mg/kg<br>= ${w} kg × 100 mg/kg = <strong>${(100*w).toFixed(0)} mg/día</strong>`},
        cefepime: { name: 'Cefepime', group: 'Cefalosporinas', dose: (w) => `Dosis diaria: <strong>${(100*w).toFixed(0)} mg</strong> (dividido c/8h).`, calculation: (w) => `Dosis total = ${w} kg × 100 mg/kg = ${(100*w).toFixed(0)} mg/día.<br>Administrar <strong>${((100*w)/3).toFixed(0)} mg</strong> cada 8 horas.`},
        piptazo: { name: 'Piperacilina-Tazobactam', group: 'Penicilinas', dose: (w) => `Dosis diaria: <strong>${(300*w).toFixed(0)} mg</strong> de Piperacilina (dividido c/6-8h).`, calculation: (w) => `Dosis total = ${w} kg × 300 mg/kg = <strong>${(300*w).toFixed(0)} mg/día</strong> de Piperacilina.`},
        meropenem: { name: 'Meropenem', group: 'Carbapenémicos', dose: (w) => `Dosis diaria: <strong>${(60*w).toFixed(0)} mg</strong> (dividido c/8h).<br><small>En BGN-KPC: hasta 120 mg/kg/día.</small>`, calculation: (w) => `Dosis total = ${w} kg × 60 mg/kg = ${(60*w).toFixed(0)} mg/día.<br>Administrar <strong>${((60*w)/3).toFixed(0)} mg</strong> cada 8 horas.`},
        vancomicina: { name: 'Vancomicina', group: 'Glicopéptidos', dose: (w) => `Dosis diaria: <strong>${(40*w).toFixed(0)} a ${(60*w).toFixed(0)} mg</strong> (dividido c/6h).`, calculation: (w) => `Rango diario: ${w} kg × (40-60) mg/kg = <strong>${(40*w).toFixed(0)}-${(60*w).toFixed(0)} mg/día</strong>.`},
        anfotericina: { name: 'Anfotericina B Liposomal', group: 'Antifúngicos', dose: (w) => `Dosis diaria: <strong>${(3*w).toFixed(0)} a ${(5*w).toFixed(0)} mg</strong>.`, calculation: (w) => `Rango diario: ${w} kg × (3-5) mg/kg = <strong>${(3*w).toFixed(0)}-${(5*w).toFixed(0)} mg/día</strong>.`},
        voriconazol: { name: 'Voriconazol', group: 'Antifúngicos', dose: (w) => `Dosis de Carga (2 dosis): <strong>${(9*w).toFixed(0)} mg/dosis</strong>.<br>Mantenimiento: <strong>${(8*w).toFixed(0)} mg/dosis</strong> (c/12h si >12a, c/8h si <12a).`, calculation: (w) => `Carga = ${w} kg × 9 mg/kg = <strong>${(9*w).toFixed(0)} mg/dosis</strong>.<br>Manto = ${w} kg × 8 mg/kg = <strong>${(8*w).toFixed(0)} mg/dosis</strong>.`},
        caspofungina: { name: 'Caspofungina', group: 'Antifúngicos', requiresHeight: true, dose: (w, h) => { const bsa = Math.sqrt((w*h)/3600); return `SC: <strong>${bsa.toFixed(2)} m²</strong><br>Dosis Carga: <strong>${Math.min(70, 70*bsa).toFixed(0)} mg</strong>.<br>Mantenimiento: <strong>${Math.min(50, 50*bsa).toFixed(0)} mg/día</strong>.` }, calculation: (w,h) => { const bsa = Math.sqrt((w*h)/3600); return `1. SC (m²) = √((Peso × Altura) / 3600)<br>= √((${w}×${h})/3600) = <strong>${bsa.toFixed(2)} m²</strong>.<br>2. Carga = SC × 70 mg/m² = <strong>${Math.min(70, 70*bsa).toFixed(0)} mg</strong> (Máx 70mg).<br>3. Manto = SC × 50 mg/m² = <strong>${Math.min(50, 50*bsa).toFixed(0)} mg</strong> (Máx 50mg).`}},
        prednisona_pti: { name: 'Prednisona', group: 'Corticoides', dose: (w) => `Dosis PTI: <strong>${Math.min(4*w, 180).toFixed(1)} mg/día</strong> (por 4 días).`, calculation: (w) => `Dosis = ${w} kg × 4 mg/kg = ${(4*w).toFixed(1)} mg.<br>Dosis final (máx 180mg): <strong>${Math.min(4*w, 180).toFixed(1)} mg/día</strong>.`},
        metilprednisolona_pti: { name: 'Metilprednisolona', group: 'Corticoides', dose: (w) => `Dosis PTI: <strong>${Math.min(30*w, 1000).toFixed(0)} mg/dosis</strong> (por 3 días).`, calculation: (w) => `Dosis = ${w} kg × 30 mg/kg = ${(30*w).toFixed(0)} mg.<br>Dosis final (máx 1g): <strong>${Math.min(30*w, 1000).toFixed(0)} mg/dosis</strong>.`},
    };

    function setupDrugCalculator() {
        const select = document.getElementById('drug-select');
        const heightContainer = document.getElementById('drug-height-container');
        const calculateBtn = document.getElementById('calculate-drug-btn');
        select.addEventListener('change', () => {
            const drugKey = select.value;
            heightContainer.classList.toggle('hidden', !drugDb[drugKey]?.requiresHeight);
        });
        calculateBtn.addEventListener('click', () => {
            const drugKey = select.value;
            const weight = parseFloat(document.getElementById('drug-weight').value);
            const height = parseFloat(document.getElementById('drug-height').value);
            const resultDiv = document.getElementById('drug-result');
            if (!drugKey || !weight || weight <= 0) {
                resultDiv.innerHTML = `<p class="text-red-600">Por favor, seleccione un fármaco e ingrese un peso válido.</p>`;
                resultDiv.classList.remove('hidden'); return;
            }
            const drug = drugDb[drugKey];
            if (drug.requiresHeight && (!height || height <= 0)) {
                resultDiv.innerHTML = `<p class="text-red-600">Este fármaco requiere peso y altura válidos.</p>`;
                resultDiv.classList.remove('hidden'); return;
            }
            const doseHtml = drug.dose(weight, height);
            const calcHtml = drug.calculation(weight, height);
            const nameUrl = `https://farmacia.garrahan.gov.ar/Vademecum/Busqueda?texto=${encodeURIComponent(drug.name)}`;
            const groupUrl = `https://farmacia.garrahan.gov.ar/Vademecum/BusquedaGrupoTerapeutico`;
            resultDiv.innerHTML = `<h4 class="font-bold text-lg">${drug.name}</h4><div class="mt-2">${doseHtml}</div>
                <details class="mt-3 text-sm"><summary class="font-semibold text-blue-600 cursor-pointer">Ver Cálculo</summary><div class="mt-2 p-2 bg-gray-200 dark:bg-gray-700 rounded">${calcHtml}</div></details>
                <div class="mt-4 text-sm flex space-x-4 border-t border-custom pt-3"><a href="${nameUrl}" target="_blank" rel="noopener" class="text-blue-600 hover:underline">Vademecum (Nombre)</a><a href="${groupUrl}" target="_blank" rel="noopener" class="text-blue-600 hover:underline">Vademecum (Grupo)</a></div>`;
            resultDiv.classList.remove('hidden');
        });
    }

    // --- BLOQUE CORREGIDO ---
    // He separado cada función con punto y coma (;) y he eliminado las llaves extra.
    function attachCalculatorFunctions() {
        window.validateWeight = (weight, resultDiv) => {
            if (!weight || weight <= 0) {
                resultDiv.innerHTML = '<p class="text-red-600">Ingrese un peso válido.</p>';
                resultDiv.classList.remove("hidden");
                return false;
            }
            return true;
        };
        window.calculateTlsRisk = () => {
            const resultDiv = document.getElementById("slt-risk-result");
            const ldh = document.getElementById("slt-ldh").value;
            let tumorType = document.getElementById("slt-tumor-type").value;
            if (ldh === "alto" && tumorType === "moderado") {
                tumorType = "alto";
            }
            let riskHtml = "";
            if (tumorType === "alto") {
                riskHtml = '<span class="font-bold text-red-700">RIESGO ALTO.</span> Considerar Rasburicase.';
            } else if (tumorType === "moderado") {
                riskHtml = '<span class="font-bold text-orange-700">RIESGO MODERADO.</span> Iniciar Alopurinol.';
            } else {
                riskHtml = '<span class="font-bold text-green-700">RIESGO BAJO.</span> Monitoreo.';
            }
            resultDiv.innerHTML = riskHtml;
            resultDiv.classList.remove("hidden");
        };
        window.calculateBsaAndHydration = () => {
            const weight = parseFloat(document.getElementById("bsa-weight").value);
            const height = parseFloat(document.getElementById("bsa-height").value);
            const resultDiv = document.getElementById("bsa-result");
            if (!weight || !height || weight <= 0 || height <= 0) {
                resultDiv.innerHTML = '<p class="text-red-600">Datos inválidos.</p>';
                resultDiv.classList.remove("hidden");
                return;
            }
            if (weight < 10) {
                resultDiv.innerHTML = `<p class="font-bold">Hidratación: ${(200 * weight).toFixed(0)} ml/día</p>`;
            } else {
                const bsa = Math.sqrt((weight * height) / 3600);
                resultDiv.innerHTML = `<p>SC: <span class="font-bold">${bsa.toFixed(2)} m²</span> | Hidratación: <span class="font-bold">${(3000 * bsa).toFixed(0)} ml/día</span></p>`;
            }
            resultDiv.classList.remove("hidden");
        };
        window.calculateHyperkalemia = () => {
            const weight = parseFloat(document.getElementById("kalemia-weight").value);
            const resultDiv = document.getElementById("kalemia-result");
            if (validateWeight(weight, resultDiv)) {
                resultDiv.innerHTML = `<ul class="text-sm space-y-1"><li><strong class="text-blue-700 dark:text-blue-400">Gluconato Ca 10%:</strong> ${(1.5 * weight).toFixed(1)} ml</li><li><strong class="text-blue-700 dark:text-blue-400">Sol. Polarizante:</strong> ${(0.75 * weight).toFixed(1)}g Glucosa + ${(0.075 * weight).toFixed(2)}U Insulina</li><li><strong class="text-blue-700 dark:text-blue-400">NaHCO3:</strong> ${(1.5 * weight).toFixed(1)} mEq</li></ul>`;
                resultDiv.classList.remove("hidden");
            }
        };
        window.calculateIronDose = () => {
            const weight = parseFloat(document.getElementById("iron-weight").value);
            const hbTarget = parseFloat(document.getElementById("iron-hb-target").value);
            const hbActual = parseFloat(document.getElementById("iron-hb-actual").value);
            const resultDiv = document.getElementById("iron-result");
            if (!weight || !hbTarget || !hbActual || weight <= 0) {
                resultDiv.innerHTML = '<p class="text-red-600">Datos inválidos.</p>';
                resultDiv.classList.remove("hidden");
                return;
            }
            const ironDose = (hbTarget - hbActual) * 0.01 * weight * 80 * 3.4 * 1.5;
            resultDiv.innerHTML = `Dosis total a reponer: <strong class="text-lg">${ironDose.toFixed(0)} mg</strong>`;
            resultDiv.classList.remove("hidden");
        };
        window.calculateIronProphylaxis = () => {
            const weight = parseFloat(document.getElementById("prophylaxis-weight").value);
            const resultDiv = document.getElementById("prophylaxis-result");
            if (validateWeight(weight, resultDiv)) {
                const condition = document.getElementById("prophylaxis-condition").value;
                const doses = { "term": 1, "preterm-1500-2000": 2, "preterm-750-1500": 3.5, "preterm-lt-750": 5.5 };
                resultDiv.innerHTML = `Dosis: <strong class="text-lg">${(doses[condition] * weight).toFixed(1)} mg/día</strong> de Hierro elemental.`;
                resultDiv.classList.remove("hidden");
            }
        };
        window.diagnoseMicrocyticAnemia = () => {
            const ferremia = document.getElementById("diff-ferremia").value;
            const saturation = document.getElementById("diff-saturation").value;
            const ferritin = document.getElementById("diff-ferritin").value;
            const hba2 = document.getElementById("diff-hba2").value;
            const resultDiv = document.getElementById("differential-result");
            let diagnosis = '<span class="font-bold">Patrón no concluyente.</span>';
            if (ferremia === 'D' && saturation === 'D' && ferritin === 'D') {
                diagnosis = '<span class="font-bold text-green-700">Orientación: Anemia Ferropénica.</span>';
            } else if (ferremia === 'N' && saturation === 'N' && ferritin === 'N' && hba2 === 'A') {
                diagnosis = '<span class="font-bold text-blue-700">Orientación: Beta Talasemia.</span>';
            } else if (ferremia === 'D' && ferritin === 'A') {
                diagnosis = '<span class="font-bold text-orange-700">Orientación: Anemia de la Inflamación.</span>';
            }
            resultDiv.innerHTML = diagnosis;
            resultDiv.classList.remove("hidden");
        };
        window.calculatePtiDose = () => {
            const weight = parseFloat(document.getElementById("pti-weight").value);
            const resultDiv = document.getElementById("pti-result");
            if (validateWeight(weight, resultDiv)) {
                const treatment = document.getElementById("pti-treatment").value;
                let doseHtml = "";
                if (treatment === "prednisona") {
                    doseHtml = `Prednisona: <strong>${Math.min(4 * weight, 180).toFixed(1)} mg/día</strong> (4 días).`;
                } else if (treatment === "metilprednisolona") {
                    doseHtml = `Metilprednisolona: <strong>${Math.min(30 * weight, 1000).toFixed(0)} mg/dosis</strong> (3 dosis).`;
                } else if (treatment === "igiv") {
                    doseHtml = `Inmunoglobulina IV: <strong>${(1 * weight).toFixed(1)} g/día</strong> (1-2 días).`;
                }
                resultDiv.innerHTML = doseHtml;
                resultDiv.classList.remove("hidden");
            }
        };
        window.calculateTransfusion = () => {
            const weight = parseFloat(document.getElementById("trans-weight").value);
            const resultDiv = document.getElementById("transfusion-result");
            if (validateWeight(weight, resultDiv)) {
                const component = document.querySelector('input[name="component"]:checked').value;
                resultDiv.innerHTML = component === "rbc" ?
                    `Dosis GR: <strong class="text-lg">${(10 * weight).toFixed(0)} ml</strong> (10 ml/kg).` :
                    `Dosis Plaquetas: <strong class="text-lg">${Math.round(weight / 10)} U</strong> (1U c/10 kg).`;
                resultDiv.classList.remove("hidden");
            }
        };
        window.calculateIgivInfusion = () => {
            const weight = parseFloat(document.getElementById("igiv-weight").value); // 't' ahora es 'weight'
            const resultDiv = document.getElementById("igiv-result");
            if (validateWeight(weight, resultDiv)) {
                const rates = [0.3, 0.6, 1.2, 2.4, 4.8, 6, 7.2];
                const intervals = ["30", "30", "30", "30", "hasta finalizar", "hasta finalizar", "hasta finalizar"];
                let tableHtml = '<h4 class="font-bold mb-2">Plan de Infusión Sugerido</h4><div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="bg-gray-200 dark:bg-gray-600"><tr><th class="p-2">Intervalo (min)</th><th class="p-2">Velocidad (mL/kg/h)</th><th class="p-2">Velocidad (mL/hora)</th></tr></thead><tbody>';
                rates.forEach((rate, index) => { // 't' del bucle ahora es 'rate'
                    // CORREGIDO: Usaba una variable 'w' que no existía, ahora usa 'weight'
                    const speed = Math.min(rate * weight, 150).toFixed(1);
                    tableHtml += `<tr class="border-b border-custom"><td class="p-2">${intervals[index]}</td><td class="p-2">${rate}</td><td class="p-2 font-bold">${speed}</td></tr>`;
                });
                tableHtml += '</tbody></table></div><p class="text-xs mt-2 italic">Basado en plantilla Garrahan. Monitorear al paciente.</p>';
                resultDiv.innerHTML = tableHtml;
                resultDiv.classList.remove("hidden");
            }
        };
        window.handleNfAlgorithm = (step) => {
            const section = document.getElementById("neutropenia-febril");
            const step1 = section.querySelector("#nf-step-1");
            const step2 = section.querySelector("#nf-step-2");
            const result = section.querySelector("#nf-result");
            const resetBtn = section.querySelector("#nf-reset-btn");
            let resultHtml = "";
            step1.classList.add("hidden");
            if (step === 'sepsis_yes') {
                resultHtml = '<p class="font-bold text-red-700">Tratamiento:</p><p>Carbapenem + Vancomicina.</p>';
            } else if (step === 'sepsis_no') {
                step2.classList.remove("hidden");
                return;
            } else if (step === 'nfar_yes') {
                resultHtml = '<p class="font-bold text-orange-700">Tratamiento (NFAR):</p><p>Cefepime o Pipe-Tazo.</p>';
                step2.classList.add("hidden");
            } else if (step === 'nfar_no') {
                resultHtml = '<p class="font-bold text-green-700">Tratamiento (NFBR):</p><p>Ceftriaxona o Cefotaxima.</p>';
                step2.classList.add("hidden");
            }
            result.innerHTML = resultHtml;
            result.classList.remove("hidden");
            resetBtn.classList.remove("hidden");
        };
        window.resetNfAlgorithm = () => {
            const section = document.getElementById("neutropenia-febril");
            section.querySelector("#nf-step-1").classList.remove("hidden");
            section.querySelector("#nf-step-2").classList.add("hidden");
            section.querySelector("#nf-result").classList.add("hidden");
            section.querySelector("#nf-reset-btn").classList.add("hidden");
        };
        window.handleCvcAlgorithm = (step) => {
            const section = document.getElementById("neutropenia-febril");
            const step1 = section.querySelector("#cvc-step-1");
            const step2 = section.querySelector("#cvc-step-2");
            const result = section.querySelector("#cvc-result");
            const resetBtn = section.querySelector("#cvc-reset-btn");
            let resultHtml = "";
            step1.classList.add("hidden");
            if (step === 'comp_yes') {
                resultHtml = '<p class="font-bold text-red-700">Acción:</p><p>Remover CVC + Terapia Sistémica.</p>';
            } else if (step === 'comp_no') {
                step2.classList.remove("hidden");
                return;
            } else if (step === 'microbe_selected') {
                const microbe = section.querySelector("#cvc-microorganism").value;
                if (microbe === 's_aureus') {
                    resultHtml = '<p class="font-bold text-red-700">Acción:</p><p>Remover CVC + Terapia Sistémica.</p>';
                } else {
                    resultHtml = '<p class="font-bold text-green-700">Acción:</p><p>Terapia de Rescate (Sistémica + Sello).</p>';
                }
                step2.classList.add("hidden");
            }
            result.innerHTML = resultHtml;
            result.classList.remove("hidden");
            resetBtn.classList.remove("hidden");
        };
        window.resetCvcAlgorithm = () => {
            const section = document.getElementById("neutropenia-febril");
            section.querySelector("#cvc-step-1").classList.remove("hidden");
            section.querySelector("#cvc-step-2").classList.add("hidden");
            section.querySelector("#cvc-result").classList.add("hidden");
            section.querySelector("#cvc-reset-btn").classList.add("hidden");
        };
    }

    function setupTheme() {
        const toggle = document.getElementById("theme-toggle");
        const lightIcon = document.getElementById("theme-icon-light");
        const darkIcon = document.getElementById("theme-icon-dark");
        const applyTheme = (theme) => {
            document.documentElement.classList.toggle("dark", theme === "dark");
            lightIcon.classList.toggle("hidden", theme === "dark");
            darkIcon.classList.toggle("hidden", theme !== "dark");
        };
        let currentTheme = localStorage.getItem("theme") || "light";
        applyTheme(currentTheme);
        toggle.addEventListener("click", () => {
            currentTheme = document.documentElement.classList.contains("dark") ? "light" : "dark";
            localStorage.setItem("theme", currentTheme);
            applyTheme(currentTheme);
        });
    }

    function setupMobileMenu() {
        document.getElementById("mobile-menu-button").addEventListener("click", () => document.getElementById("mobile-menu").classList.toggle("hidden"));
    }

    function setupTabs() {
        document.querySelectorAll(".tab-btn").forEach(button => {
            button.addEventListener("click", () => {
                const tabId = button.dataset.tab;
                const card = button.closest(".bg-card");
                card.querySelectorAll(".tab-btn").forEach(btn => btn.classList.remove("active"));
                button.classList.add("active");
                card.querySelectorAll(".tab-content").forEach(content => {
                    content.classList.toggle("active", content.id === `tab-content-${tabId}`);
                });
            });
        });
    }

    function setupFavorites() {
        const toggleBtn = document.getElementById("favorites-toggle-btn");
        const closeBtn = document.getElementById("close-favorites-btn");
        const panel = document.getElementById("favorites-panel");
        toggleBtn.addEventListener("click", () => panel.classList.remove("translate-x-full"));
        closeBtn.addEventListener("click", () => panel.classList.add("translate-x-full"));
        loadFavorites();
        document.querySelectorAll(".favorite-btn").forEach(btn => {
            btn.addEventListener("click", (e) => {
                e.stopPropagation();
                toggleFavorite(btn.dataset.id, btn.dataset.title);
            });
        });
    }

    function getFavorites() {
        return JSON.parse(localStorage.getItem("hemoncoFavoritesV5")) || [];
    }

    function saveFavorites(favorites) {
        localStorage.setItem("hemoncoFavoritesV5", JSON.stringify(favorites));
        loadFavorites();
    }

    function toggleFavorite(id, title) {
        let favorites = getFavorites();
        const index = favorites.findIndex(fav => fav.id === id);
        if (index > -1) {
            favorites.splice(index, 1);
        } else {
            favorites.push({ id, title });
        }
        saveFavorites(favorites);
    }

    function loadFavorites() {
        const favorites = getFavorites();
        document.querySelectorAll(".favorite-btn").forEach(btn => {
            btn.classList.toggle("saved", favorites.some(fav => fav.id === btn.dataset.id));
        });
        const listContainer = document.getElementById("favorites-list");
        if (favorites.length === 0) {
            listContainer.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">Guarde secciones con ★ para verlas aquí.</p>';
            return;
        }
        listContainer.innerHTML = favorites.map(fav =>
            `<a href="#${fav.id}" class="block p-2 bg-gray-100 dark:bg-gray-700 rounded hover:bg-blue-100 dark:hover:bg-blue-900 transition-colors text-sm">${fav.title}</a>`
        ).join("");
        listContainer.querySelectorAll("a").forEach(link => {
            link.addEventListener("click", () => document.getElementById("favorites-panel").classList.add("translate-x-full"));
        });
    }

    function setupGlobalSearch() {
        const searchInput = document.getElementById("global-search-input");
        const performSearch = (query) => {
            removeHighlights();
            if (query.length < 3) return;
            const regex = new RegExp(query, "gi");
            highlightText(document.getElementById("main-content"), regex);
        };
        const highlightText = (node, regex) => {
            if (node.nodeType === 3) { // Es un nodo de texto
                if (node.nodeValue.match(regex)) {
                    const wrapper = document.createElement("span");
                    wrapper.innerHTML = node.nodeValue.replace(regex, (match) => `<span class="highlight">${match}</span>`);
                    node.parentNode.replaceChild(wrapper, node);
                }
            } else if (node.nodeType === 1 && node.childNodes && !/script|style|svg/i.test(node.tagName)) { // Es un elemento
                node.childNodes.forEach(child => highlightText(child, regex));
            }
        };
        searchInput.addEventListener("input", (e) => performSearch(e.target.value));
    }

    function removeHighlights() {
        document.querySelectorAll("span.highlight").forEach(el => {
            const parent = el.parentNode;
            if (parent) {
                parent.replaceChild(document.createTextNode(el.textContent), el);
                parent.normalize(); // Fusiona nodos de texto adyacentes
            }
        });
    }
</script>
